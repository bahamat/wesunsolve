#!/usr/bin/php
<?php
/**
 * Load patches into database
 *
 * @author Gouverneur Thomas <tgo@ians.be>
 * @copyright Copyright (c) 2011, Gouverneur Thomas
 * @version 1.0
 * @package CLI
 * @category utils
 * @subpackage list
 * @filesource
 */

  require_once("../libs/config.inc.php");
  require_once("../libs/autoload.lib.php");

  echo "[-] Connecting to MySQL...";
  $m = mysqlCM::getInstance();
  if ($m->connect()) {
    die($argv[0]." Error with SQL db: ".$m->getError()."\n");
  }
  echo "done\n";

  $bugids = array();
  $table = "`bugids`";
  $index = "`id`";
  $where = "";

  if (($idx = mysqlCM::getInstance()->fetchIndex($index, $table, $where)))
  { 
    foreach($idx as $t) {
      $g = new Bugid($t['id']);
      array_push($bugids, $g);
    }
  }

  foreach ($bugids as $bug) {
    $dir1 = substr($bug->id, 0, 2);
    $dir2 = substr($bug->id, 2, 2);
    if (!is_dir($config['bidpath']."/".$dir1)) {
      mkdir($config['bidpath']."/".$dir1);
    }
    if (!is_dir($config['bidpath']."/".$dir1."/".$dir2)) {
      mkdir($config['bidpath']."/".$dir1."/".$dir2);
    }

    echo "[-] Checking for ".$config['bidpath']."/".$dir1."/".$dir2."/".$bug->id.".html\n";
    if (file_exists($config['bidpath']."/$dir1/$dir2/".$bug->id.".html")) {
      continue;
    }
    $outfile = $config['bidpath']."/$dir1/$dir2/".$bug->id.".html";
    $url = "https://support.oracle.com/CSP/main/article?cmd=show&type=BUG&productFamily=Sun&id=".$bug->id;
    $cmd = "/usr/bin/wget --no-check-certificate -U \":-)\" --load-cookies /srv/sunsolve/bin/cookies.txt --save-cookies /srv/sunsolve/bin/cookies.txt --keep-session-cookies -O \"$outfile\" \"$url\"";
    passthru($cmd);
  }

  echo "[-] Disonnecting from MySQL...";
  $m->disconnect();
  echo "done\n";
?>
