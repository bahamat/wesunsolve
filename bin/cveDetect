#!/usr/bin/php
<?php
/**
 * Detect CVEs
 *
 * @author Gouverneur Thomas <tgo@espix.net>
 * @copyright Copyright (c) 2011-2012, Gouverneur Thomas
 * @version 1.0
 * @package CLI
 * @category utils
 * @subpackage list
 * @filesource
 */

  require_once("../libs/config.inc.php");
  require_once("../libs/autoload.lib.php");
  require_once("../libs/functions.lib.php");

/*

  $shortopts = "p::r::hlfva";
  $opts = getopt($shortopts);

  if (isset($opts['h'])) {
    echo $argv[0]."\n";
    echo "\t [-r=<repo name>]\n";
    echo "\t [-p=<pkg filter>]\n";
    echo "\t [-l] list repo\n";
    echo "\t [-v] view only\n";
    echo "\t [-f] do not index files\n";
    echo "\t [-a] do not announce new packages\n";
    exit();
  }
*/

  $m = mysqlCM::getInstance();
  if ($m->connect()) {
    die($argv[0]." Error with SQL db: ".$m->getError()."\n");
  }

  exec('/srv/sunsolve/bin/cveDetect.py', $cves);
  foreach($cves as $line) {
    $line = trim($line);
    if (empty($line)) {
      continue;
    }
    $f = explode(';', $line);
    $cvename = $f[0];
    $affect = $f[1];
    $fix = $f[2];
    $cve = new CVE();
    $cve->name = $cvename;
    if ($cve->fetchFromField("name")) {
      $cve->insert();
      echo "[-] Found new CVE: $cvename\n";
    }
    if (empty($cve->desc) || empty($cve->score) || empty($cve->severity) ||
	$cve->released <= 0 || $cve->revised <= 0) {
      echo "[-] Trying to gather informations on $cve...\n";
      $infos = array();
      exec('/srv/sunsolve/bin/cveInfos.py '.$cve->name, $infos);
      $i=0;
      $desc = '';
      $score = '';
      $severity = '';
      $revised = '';
      $released = '';
      foreach($infos as $line) {
        switch($i) {
          case 0:
	    $released = explode('/', preg_replace('/Original release date:/', '', $line));
	    $released = mktime(0,0,0,$released[0], $released[1], $released[2]);
	    break;
	  case 1:
	    $revised = explode('/', preg_replace('/Last revised:/', '', $line));
	    $revised = mktime(0,0,0,$revised[0], $revised[1], $revised[2]);
	    break;
	  case 2:
            $score = $line;
	    break;
	  default:
	    $line = trim($line);
            if (empty($line)) continue;
            $desc .= ' '.$line;
            break;
        }
        $i++;
      }
      echo "\t> Found desc: $desc\n";
      $score = preg_replace('/CVSS v2 Base Score:([0-9]{1,2}\.[0-9]{1})\(([A-Z]*)\).*$/', '${1} ${2}', $score);
      $score = explode(' ', $score);
      $severity = $score[1];
      $score = $score[0];
      echo "\t> Found score: $score\n";
      echo "\t> Found severity: $severity\n";
      $cve->desc = $desc;
      $cve->score = $score;
      $cve->severity = $severity;
      $cve->released = $released;
      $cve->revised = $revised;
      echo "\t> Found released: $released\n";
      echo "\t> Found revised: $revised\n";
      $cve->update();
    }
    if (strcmp($cve->affect, $affect)) {
      $cve->affect = $affect;
      $cve->update();
      echo "[-] $cve affect $affect\n";
    }
    $cve->fetchPatches(1);
    $fixes = explode(',', $fix);
    foreach($fixes as $fix) {
      $fix = trim($fix);
      if (empty($fix)) continue;
      if (!preg_match("/[0-9]{6}-[0-9]{2}/", $fix)) { // this is not a patch
        echo "[!] Found fix for $cvename which is not a patch: $fix\n";
	continue;
      }
      $p = explode('-', $fix);
      $p = new Patch($p[0], $p[1]);
      if ($p->fetchFromId()) {
        echo "[!] Patch not found $p\n";
        continue;
      }
      if (!$cve->isPatch($p)) {
        $cve->addPatch($p);
	echo "[-] Linked $p to $cve\n";
      }
    }
  }

?>
